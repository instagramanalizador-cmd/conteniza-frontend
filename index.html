<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conteniza - Generador de Contenido con IA</title>
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="consent.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #8B5FBF;
      --primary-dark: #7A4BA8;
      --secondary: #FF6B9D;
      --accent: #6ECBF5;
      --success: #2CD4A4;
      --danger: #FF6B6B;
      --warning: #FFA36B;
      --bg: #0F0F1E;
      --bg-light: #1A1A2E;
      --card: #FFFFFF;
      --text: #2D3748;
      --text-light: #718096;
      --border: #E9D8FD;
      --gradient-primary: linear-gradient(135deg, #8B5FBF 0%, #FF6B9D 100%);
      --gradient-success: linear-gradient(135deg, #2CD4A4 0%, #6ECBF5 100%);
      --gradient-warning: linear-gradient(135deg, #FFA36B 0%, #FF6B6B 100%);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-light) 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 400px;
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      font-weight: 600;
    }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification.success {
      background: var(--gradient-success);
    }
    
    .notification.error {
      background: var(--gradient-warning);
    }
    
    .notification.show {
      display: block;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(139, 95, 191, 0.15);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .header h1 {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    
    .header .subtitle {
      color: var(--text-light);
      font-size: 16px;
      font-weight: 500;
    }

/* Estilos del logo */
.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

.logo {
  width: 100px;
  height: 100px;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(139, 95, 191, 0.2);
  animation: fadeInLogo 0.6s ease;
  transition: transform 0.3s ease;
}

.logo:hover {
  transform: scale(1.05) rotate(2deg);
}

@keyframes fadeInLogo {
  from { 
    opacity: 0; 
    transform: scale(0.8) rotate(-5deg); 
  }
  to { 
    opacity: 1; 
    transform: scale(1) rotate(0deg); 
  }
}    

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(139, 95, 191, 0.1);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(139, 95, 191, 0.2);
    }
    
    .plans-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin: 40px 0;
    }
    
    .plan-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 32px;
      text-align: center;
      position: relative;
      overflow: hidden;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .plan-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 60px rgba(139, 95, 191, 0.3);
    }
    
    .plan-card.featured {
      border-color: var(--primary);
      transform: scale(1.05);
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
    }
    
    .plan-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--gradient-warning);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
    }
    
    .plan-name {
      font-size: 24px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 16px;
      text-transform: uppercase;
    }
    
    .plan-price {
      font-size: 48px;
      font-weight: 900;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    
    .plan-price-period {
      color: var(--text-light);
      font-size: 16px;
      margin-bottom: 24px;
    }
    
    .plan-features {
      text-align: left;
      margin: 24px 0;
    }
    
    .plan-feature {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(233, 216, 253, 0.5);
    }
    
    .plan-feature:last-child {
      border-bottom: none;
    }
    
    .plan-feature::before {
      content: "✓";
      color: var(--success);
      font-weight: 900;
      font-size: 20px;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
      background: rgba(255,255,255,0.8);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(139, 95, 191, 0.1);
      background: white;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 8px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 28px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(139, 95, 191, 0.4);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--primary);
      color: white;
    }
    
    .btn-success {
      background: var(--gradient-success);
      color: white;
    }
    
    .btn-danger {
      background: var(--gradient-warning);
      color: white;
    }
    
    .btn-full {
      width: 100%;
    }
    
    .user-panel {
      background: var(--gradient-primary);
      color: white;
      padding: 24px;
      border-radius: 24px;
      margin-bottom: 24px;
      display: none;
      box-shadow: 0 8px 32px rgba(139, 95, 191, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .user-credits {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 20px;
      border-radius: 20px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 16px 0;
      background: rgba(248, 250, 252, 0.5);
    }
    
    .file-upload-area:hover {
      border-color: var(--primary);
      background: rgba(139, 95, 191, 0.05);
      transform: translateY(-2px);
    }
    
    .file-upload-area input {
      display: none;
    }
    
    .file-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .file-preview-item {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-light);
      aspect-ratio: 1;
      transition: transform 0.3s ease;
    }
    
    .file-preview-item:hover {
      transform: scale(1.05);
    }
    
    .file-preview-item img,
    .file-preview-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .file-preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--danger);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .file-preview-remove:hover {
      transform: scale(1.1);
      background: #dc2626;
    }
    
    .progress-container {
      margin: 24px 0;
      display: none;
    }
    
    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 8px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      text-align: center;
      margin-top: 8px;
      font-size: 14px;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .progress-subtask {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-light);
      text-align: center;
      display: none;
    }
    
    .results-section {
      display: none;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    
    .result-card {
      background: linear-gradient(145deg, rgba(139, 95, 191, 0.05), rgba(110, 203, 245, 0.05));
      border: 1px solid rgba(139, 95, 191, 0.1);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
    }
    
    .result-card h3 {
      color: var(--primary);
      font-size: 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .copy-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .copy-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }
    
    .chip {
      display: inline-block;
      padding: 10px 18px;
      background: linear-gradient(145deg, #eff6ff, #dbeafe);
      border: 1px solid #bfdbfe;
      border-radius: 20px;
      margin: 6px 6px 6px 0;
      font-size: 14px;
      font-weight: 500;
      color: #1e40af;
      transition: all 0.3s ease;
    }
    
    .chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .caption-item {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .caption-item:hover {
      transform: translateX(4px);
    }
    
    .carousel-container {
      position: relative;
      overflow: hidden;
      margin: 24px 0;
    }
    
    .carousel-slides {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 16px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--border);
    }
    
    .carousel-slide {
      min-width: 280px;
      height: 200px;
      background: var(--gradient-primary);
      border-radius: 16px;
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .carousel-slide:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }
    
    .carousel-slide-number {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255, 255, 255, 0.2);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }
    
    .carousel-slide h4 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    
    .carousel-slide p {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.95;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .validation-error {
      border-color: var(--danger) !important;
      background-color: #fef2f2;
      animation: shake 0.5s ease-in-out;
    }
    
    .validation-success {
      border-color: var(--success) !important;
      background-color: #f0fdf4;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .slider-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
    }
    
    .slider-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(139, 95, 191, 0.3);
    }
    
    .slider-btn:hover {
      transform: scale(1.1);
      background: var(--primary-dark);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }
.logo {
    width: 45px;
    height: 45px;
  }
  
  .header-content {
    justify-content: center;
  }
  /* FIN ✅ */
  
  .header h1 {
    font-size: 24px;
  }
      
      .header h1 {
        font-size: 24px;
      }
      
      .plans-container {
        grid-template-columns: 1fr;
      }
      
      .plan-card.featured {
        transform: scale(1);
      }
      
      .user-info {
        flex-direction: column;
        text-align: center;
      }
      
      .result-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 20px;
      }
    }
    
    .hidden {
      display: none !important;
    }

/* ============================================
   🎨 SIDEBAR DE HISTORIAL - NUEVO
   ============================================ */

/* Overlay oscuro de fondo */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 15, 30, 0.85);
  backdrop-filter: blur(8px);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.sidebar-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* Sidebar contenedor */
.sidebar {
  position: fixed;
  top: 0;
  left: -25%; /* Oculto inicialmente */
  width: 25%;
  height: 100vh;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%);
  box-shadow: 4px 0 24px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  overflow-y: auto;
  transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-right: 1px solid rgba(139, 95, 191, 0.2);
}

.sidebar.active {
  left: 0; /* Visible */
}

/* Header del sidebar */
.sidebar-header {
  position: sticky;
  top: 0;
  background: var(--gradient-primary);
  padding: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.sidebar-header h2 {
  color: white;
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-close {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 600;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.sidebar-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

/* Contenido del sidebar */
.sidebar-content {
  padding: 20px;
}

/* Items del historial */
.history-item {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 2px solid transparent;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.history-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--gradient-primary);
  transition: width 0.3s ease;
}

.history-item:hover {
  transform: translateX(4px);
  box-shadow: 0 8px 24px rgba(139, 95, 191, 0.2);
  border-color: rgba(139, 95, 191, 0.3);
}

.history-item:hover::before {
  width: 8px;
}

.history-date {
  font-size: 12px;
  color: var(--text-light);
  font-weight: 500;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.history-niche {
  font-size: 14px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.history-description {
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Badge de coherencia */
.coherence-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-top: 8px;
}

.coherence-badge.coherent {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border: 1px solid #6ee7b7;
}

.coherence-badge.incoherent {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
  border: 1px solid #fca5a5;
}

/* Estado vacío */
.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  color: var(--text);
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
}

.empty-state p {
  color: var(--text-light);
  font-size: 14px;
}

/* Botón flotante para abrir sidebar */
.sidebar-toggle-btn {
  position: fixed;
  bottom: 24px;
  left: 24px;
  width: 60px;
  height: 60px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: none; /* Oculto por defecto */
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 8px 24px rgba(139, 95, 191, 0.4);
  z-index: 9997;
  transition: all 0.3s ease;
}

.sidebar-toggle-btn:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 12px 32px rgba(139, 95, 191, 0.6);
}

.sidebar-toggle-btn.active {
  display: flex; /* Visible cuando hay sesión */
}

/* Scrollbar personalizado para sidebar */
.sidebar::-webkit-scrollbar {
  width: 8px;
}

.sidebar::-webkit-scrollbar-track {
  background: rgba(139, 95, 191, 0.1);
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* ============================================
   📱 RESPONSIVE MÓVIL
   ============================================ */
@media (max-width: 768px) {
  .container {
    padding: 12px;
  }
  
  .logo {
    width: 45px;
    height: 45px;
  }
  
  .header-content {
    justify-content: center;
  }
  
  .header h1 {
    font-size: 24px;
  }
  
  .plans-container {
    grid-template-columns: 1fr;
  }
  
  .plan-card.featured {
    transform: scale(1);
  }
  
  .user-info {
    flex-direction: column;
    text-align: center;
  }
  
  .result-grid {
    grid-template-columns: 1fr;
  }
  
  .card {
    padding: 20px;
  }
  
  /* ✅ SIDEBAR RESPONSIVE - AGREGADO */
  .sidebar {
    width: 80%;
    left: -80%;
  }
  
  .sidebar-toggle-btn {
    width: 50px;
    height: 50px;
    font-size: 20px;
    bottom: 20px;
    left: 20px;
  }
  
  .sidebar-header h2 {
    font-size: 18px;
  }
  
  .history-item {
    padding: 16px;
  }
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>
  <div id="notification" class="notification"></div>
  
  <!-- ============================================
       🎨 SIDEBAR DE HISTORIAL - FUERA DEL CONTAINER
       ============================================ -->
  
  <!-- Overlay oscuro de fondo -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  
  <!-- Sidebar contenedor -->
  <div class="sidebar" id="historySidebar">
    <div class="sidebar-header">
      <h2>📜 Historial</h2>
      <button class="sidebar-close" onclick="closeSidebar()">×</button>
    </div>
    <div class="sidebar-content" id="sidebarContent">
      <div class="empty-state">
        <div class="empty-state-icon">🔭</div>
        <h3>No hay análisis previos</h3>
        <p>Tus análisis aparecerán aquí</p>
      </div>
    </div>
  </div>
  
  <!-- Botón flotante para abrir sidebar -->
  <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="openSidebar()">
    📜
  </button>
  
  <div class="container">
    <!-- Header con logo -->
<div class="header">
  <div class="header-content">
    <img src="logo.jpg" alt="Conteniza Logo" class="logo">
    <h1 style="margin: 0;">Conteniza</h1>
  </div>
  <p class="subtitle">Genera contenido viral para Instagram en segundos</p>
</div>
    
    <!-- Pantalla de selección de planes -->
    <div id="plansScreen">
      <div class="card">
        <h2 style="text-align: center; margin-bottom: 32px; font-size: 28px; color: var(--primary);">
          Elige tu Plan Perfecto
        </h2>
        
        <div class="plans-container">

  <!-- PLAN FREE -->
  <div class="plan-card">
    <div class="plan-name">Free</div>
    <div class="plan-price">$0</div>
    <div class="plan-price-period">/ mes</div>
    <div class="plan-features">
      <div class="plan-feature">✅ 20 análisis por mes</div>
      <div class="plan-feature">✅ Contenido básico para Instagram</div>
      <div class="plan-feature">✅ OCR de Textos</div>
      <div class="plan-feature">✅ Ideas de Miniaturas e Stories</div>
      <div class="plan-feature">✅ Soporte por email</div>
      <div class="plan-feature">✅ Prueba Todas las Funciones</div>
      <div style="font-weight: bold; font-size: 1.3em; color: #d9534f; margin-top: -8px; margin-bottom: 0; text-align: left; padding-left: 24px;">
      POR TIEMPO LIMITADO
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="selectPlan('free')">
      Comenzar Gratis
    </button>
  </div>
  
  <!-- PLAN PRO -->
  <div class="plan-card featured">
    <div class="plan-badge">Más Popular</div>
    <div class="plan-name">Pro</div>
    <div class="plan-price">$29</div>
    <div class="plan-price-period">/ mes</div>
    <div class="plan-features">
      <div class="plan-feature">✅ 200 análisis por mes</div>
      <div class="plan-feature">✅ OCR Textos/Imagenes/10 Videos</div>
      <div class="plan-feature">✅ Contenido optimizado</div>
      <div class="plan-feature">✅ Exportación a PDF Basica</div>
      <div class="plan-feature">✅ Historial de análisis</div>
      <div class="plan-feature">✅ Soporte prioritario (24-48h)</div>
    </div>
    <button class="btn btn-primary btn-full" onclick="selectPlan('pro')">
      Unirse a Lista de Espera
    </button>
  </div>
  
  <!-- PLAN PREMIUM -->
  <div class="plan-card">
    <div class="plan-name">Premium</div>
    <div class="plan-price">$79</div>
    <div class="plan-price-period">/ mes</div>
    <div class="plan-features">
      <div class="plan-feature">✅ 1000 análisis por mes</div>
      <div class="plan-feature">✅ Contenido personalizado</div>
      <div class="plan-feature">✅ OCR de Textos/Imagenes/Audios/Videos</div>
      <div class="plan-feature">✅ Exportación Premium a PDF</div>
      <div class="plan-feature">✅ Historial de análisis</div>
      <div class="plan-feature">✅ Descargas de Miniaturas y Slide</div>
      <div class="plan-feature">✅ Soporte VIP por WhatsApp</div>
    </div>
    <button class="btn btn-primary btn-full" onclick="selectPlan('premium')">
      Unirse a Lista de Espera
    </button>
  </div>
</div>
      </div>
    </div>
    
    <div id="authScreen" class="hidden">
      <div class="card" style="max-width: 500px; margin: 40px auto;">
        <h2 style="text-align: center; margin-bottom: 24px; color: var(--primary);">
          <span id="authTitle">Iniciar Sesión</span>
        </h2>
        
        <form id="authForm" onsubmit="handleAuth(event)">
          <div class="form-group">
            <label class="form-label">📧 Email</label>
            <input type="email" id="authEmail" class="form-input" placeholder="tu@email.com" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">🔒 Contraseña</label>
            <input type="password" id="authPassword" class="form-input" placeholder="Mínimo 6 caracteres" required minlength="6">
          </div>
          
          <input type="hidden" id="selectedPlan" value="free">
          
          <button type="submit" class="btn btn-primary btn-full" id="authSubmitBtn">
            <span id="authBtnText">Iniciar Sesión</span>
          </button>
          
          <div style="text-align: center; margin-top: 16px;">
            <button type="button" class="btn btn-secondary" onclick="toggleAuthMode()" style="margin-right: 8px;">
              <span id="authToggleText">¿No tienes cuenta? Regístrate</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="showForgotPassword()">
              ¿Olvidaste tu contraseña?
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="userPanel" class="user-panel">
      <div class="user-info">
        <div>
          <h3 style="margin-bottom: 8px;">👋 Hola, <span id="userEmail">usuario@ejemplo.com</span></h3>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <span class="user-credits">
              📊 <span id="userCredits">5</span> análisis restantes
            </span>
            <span class="user-credits">
              Plan: <span id="userPlan">Free</span>
            </span>
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-secondary" onclick="openSidebar()">
            📜 Ver Historial
          </button>
          <button class="btn btn-danger" onclick="logout()">
            🚪 Cerrar Sesión
          </button>
<button class="btn btn-warning" onclick="openAdmin()" id="adminBtn" style="display: none;">
    ⚙️ Admin
</button>
        </div>
      </div>
    </div>
    
    <div id="mainApp" class="hidden">
      <div class="card">
        <h2 style="color: var(--primary); margin-bottom: 24px;">🎯 Generador de Contenido</h2>
        
        <form id="contentForm" onsubmit="generateContent(event)">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div class="form-group">
              <label class="form-label">🎯 Nicho o Temática</label>
              <input type="text" id="niche" class="form-input" placeholder="ej: finanzas personales, marketing digital">
              <div class="form-hint">El tema principal de tu contenido</div>
            </div>
            
            <div class="form-group">
              <label class="form-label">✏️ Título del Contenido (Opcional)</label>
              <input type="text" id="title" class="form-input" placeholder="Título principal">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div class="form-group">
              <label class="form-label">🎭 Tono de Comunicación</label>
              <select id="tone" class="form-select" required>
                <optgroup label="💼 Profesional">
                  <option value="Oficial/Legal">Oficial/Legal</option>
                  <option value="Profesional" selected>Profesional</option>
                  <option value="Academico">Académico</option>
                  <option value="Informativo">Informativo</option>
                </optgroup>
                <optgroup label="🔥 Dinámico">
                  <option value="Viral/Trendy">Viral/Trendy</option>
                  <option value="Energico/Dinamico">Enérgico/Dinámico</option>
                  <option value="Urgente/FOMO">Urgente/FOMO</option>
                  <option value="Competitivo/Retos">Competitivo/Retos</option>
                </optgroup>
                <optgroup label="❤️ Emocional">
                  <option value="Inspirador">Inspirador</option>
                  <option value="Emocional/Vulnerable">Emocional/Vulnerable</option>
                  <option value="Empoderador">Empoderador</option>
                  <option value="Calido/Empatico">Cálido/Empático</option>
                  <option value="Motivacional">Motivacional</option>
                </optgroup>
                <optgroup label="😂 Casual">
                  <option value="Humor/Memes">Humor/Memes</option>
                  <option value="Casual/Amigable">Casual/Amigable</option>
                  <option value="Relatable">Relatable</option>
                  <option value="Divertido">Divertido</option>
                  <option value="Celebratorio/Festivo">Celebratorio/Festivo</option>
                </optgroup>
                <optgroup label="🧠 Estratégico">
                  <option value="Persuasivo/Ventas">Persuasivo/Ventas</option>
                  <option value="Misterioso/Curioso">Misterioso/Curioso</option>
                  <option value="Controversial/Debate">Controversial/Debate</option>
                  <option value="Intelectual/Smart">Intelectual/Smart</option>
                  <option value="Storytelling">Storytelling</option>
                </optgroup>
                <optgroup label="🎯 Específico">
                  <option value="Educacional">Educacional</option>
                  <option value="Guia Practica">Guía Práctica</option>
                  <option value="Aspiracional">Aspiracional</option>
                </optgroup>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">📋 Tipo de Contenido</label>
              <select id="contentType" class="form-select" required>
                <optgroup label="📊 Informativo">
                  <option value="official">📋 Oficial/Legal</option>
                  <option value="news">📰 Noticias</option>
                  <option value="tips">💡 Tips/Consejos</option>
                  <option value="comparison">⚖️ Comparativas</option>
                  <option value="statistics">📊 Estadísticas/Datos</option>
                  <option value="faq">❓ FAQ/Preguntas Frecuentes</option>
                </optgroup>
                <optgroup label="🎓 Educativo">
                  <option value="tutorial">🎓 Tutorial</option>
                  <option value="case_study">📈 Caso de Estudio</option>
                  <option value="educational">📚 Educativo</option>
                  <option value="behind_scenes">⚡ Behind the Scenes</option>
                </optgroup>
                <optgroup label="🎯 Marketing">
                  <option value="promotional">🎯 Promocional</option>
                  <option value="testimonial">💰 Testimonios</option>
                  <option value="achievement">🏆 Logros/Celebración</option>
                </optgroup>
                <optgroup label="🔥 Engagement">
                  <option value="viral">🔥 Viral</option>
                  <option value="entertainment">🎉 Entretenimiento</option>
                  <option value="controversial">💥 Controversial</option>
                  <option value="creative">🎨 Creativo/Artístico</option>
                </optgroup>
                <optgroup label="📝 General">
                  <option value="general" selected>General</option>
                </optgroup>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">📝 Descripción del Contenido</label>
            <textarea id="description" class="form-textarea" placeholder="Describe QUÉ QUIERES que genere (ej: 'Crea hooks virales sobre lo que dice el audio', 'Resume las ideas principales del video', 'Genera captions promocionales basados en las imágenes')..."></textarea>
            <div class="form-hint">Mientras más detallada, mejores resultados obtendrás</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">🖼️ Archivos Multimedia (Imágenes, Videos, Audios)</label>
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
              <input type="file" id="fileInput" accept="image/*,video/*,audio/*" multiple onchange="handleFileSelect(event)">
              <div style="font-size: 48px; margin-bottom: 12px;">📁</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                Arrastra archivos aquí o haz clic para seleccionar
              </div>
              <div style="font-size: 14px; color: var(--text-light);">
                Máximo 10 archivos • 150MB por archivo
              </div>
            </div>
            <div id="filePreview" class="file-preview"></div>
          </div>
          
          <div id="progressContainer" class="progress-container">
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progressText" class="progress-text">Procesando...</div>
            <div id="progressSubTask" class="progress-subtask"></div>
          </div>
          
          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px;">
            <button type="submit" class="btn btn-primary" id="generateBtn">
              <span>✨ Generar Contenido</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
              🧹 Limpiar Todo
            </button>
            <button type="button" class="btn btn-success" onclick="validateInputs()">
              🔍 Validar Entradas
            </button>
          <button class="btn btn-success" onclick="generatePDF()">
            📄 Descargar PDF
          </button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="resultsSection" class="results-section">
      <div class="card">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
          <h2 style="color: var(--primary); margin: 0;">📊 Resultados del Análisis</h2>

        </div>
        
        <div class="result-grid">
          <div class="result-card">
            <h3>
              🎣 Hooks Magnéticos
              <button class="copy-btn" onclick="copyToClipboard('hooksContent')">📋 Copiar</button>
            </h3>
            <div id="hooksContent"></div>
          </div>
          
          <div class="result-card">
            <h3>
              📢 Call-to-Actions
              <button class="copy-btn" onclick="copyToClipboard('ctasContent')">📋 Copiar</button>
            </h3>
            <div id="ctasContent"></div>
          </div>
          
          <div class="result-card">
            <h3>
              😊 Emojis & Hashtags
              <button class="copy-btn" onclick="copyToClipboard('hashtagsContent')">📋 Copiar</button>
            </h3>
            <div id="emojisContent" style="font-size: 24px; margin-bottom: 16px;"></div>
            <div id="hashtagsContent"></div>
          </div>
        </div>
        
        <div class="result-card">
          <h3>
            📝 Captions Optimizados
            <button class="copy-btn" onclick="copyToClipboard('captionsContent')">📋 Copiar</button>
          </h3>
          <div id="captionsContent"></div>
        </div>
        
        <div class="result-card">
          <h3>🖼️ Ideas de Miniaturas</h3>
          <div id="thumbnailsContent"></div>
        </div>
        
        <div class="result-card">
          <h3>🎠 Ideas de Carrusel </h3>
          <div id="carouselContent" class="carousel-container">
            <div class="carousel-slides" id="carouselSlides"></div>
            <div class="slider-controls">
              <button class="slider-btn" onclick="scrollSlider('carouselSlides', -1)">‹</button>
              <button class="slider-btn" onclick="scrollSlider('carouselSlides', 1)">›</button>
            </div>
          </div>
        </div>
        
        <div class="result-card">
          <h3>📱 Ideas para Stories</h3>
          <div id="storiesContent"></div>
        </div>
        
        <div class="result-card">
          <h3>🎤 Transcripción de Audio & Texto de Imágenes</h3>
          <div id="transcriptionContent" style="font-size: 14px; line-height: 1.6;"></div>
        </div>
        
        <div class="result-card">
          <h3>📈 Análisis SEO & Tendencias</h3>
          <div id="seoContent" style="font-size: 14px; line-height: 1.6;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://conteniza-backend.onrender.com/api';
    
    let currentUser = null;
    let currentPlan = 'free';
    let authMode = 'login';
    let uploadedFiles = [];
    let currentResults = null;
    let userCredits = 5;


async function loadAnalysisById(analysisId) {
  const token = localStorage.getItem('token');
  
  try {
    const response = await fetch(`${API_URL}/analyze/${analysisId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (data.success && data.analysis) {
      currentResults = data.analysis;
      renderResults(data.analysis);
      
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('resultsSection').classList.remove('hidden');
      
      closeSidebar(); // ✅ CAMBIADO DE closeHistoryModal()
      
      showNotification('✅ Análisis cargado correctamente', 'success');
      
      setTimeout(() => {
        document.getElementById('resultsSection').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }, 300);
    }
  } catch (error) {
    showNotification('Error cargando análisis', 'error');
  }
}

// ============================================
// 🎨 FUNCIONES DEL SIDEBAR DE HISTORIAL
// ============================================

// Abrir sidebar
function openSidebar() {
  const sidebar = document.getElementById('historySidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar && overlay) {
    sidebar.classList.add('active');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    loadSidebarHistory();
  }
}

// Cerrar sidebar
function closeSidebar() {
  const sidebar = document.getElementById('historySidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar && overlay) {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }
}

// Cargar historial en el sidebar
async function loadSidebarHistory() {
  const token = localStorage.getItem('token');
  if (!token) {
    showNotification('Debes iniciar sesión primero', 'error');
    return;
  }
  
  const sidebarContent = document.getElementById('sidebarContent');
  
  try {
    sidebarContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div><p style="margin-top: 12px; color: var(--text-light);">Cargando historial...</p></div>';
    
    const response = await fetch(`${API_URL}/analyze`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.analyses || data.analyses.length === 0) {
      sidebarContent.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">🔭</div>
          <h3>No hay análisis previos</h3>
          <p>Tus análisis aparecerán aquí</p>
        </div>
      `;
      return;
    }
    
    sidebarContent.innerHTML = data.analyses.map(analysis => {
      const isCoherent = analysis.is_coherent !== false;
      const coherenceBadge = `
        <span class="coherence-badge ${isCoherent ? 'coherent' : 'incoherent'}">
          ${isCoherent ? '✓ Coherente' : '⚠ Revisar coherencia'}
        </span>
      `;
      
      return `
        <div class="history-item">
          <div class="history-date">
            📅 ${new Date(analysis.created_at).toLocaleDateString('es-ES', {
              day: '2-digit',
              month: 'long',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
          <div class="history-niche">
            🎯 ${escapeHtml(analysis.detected_niche || analysis.niche || 'Sin nicho')}
          </div>
          <div class="history-description">
            ${escapeHtml(analysis.input_description || analysis.description || 'Sin descripción')}
          </div>
          ${coherenceBadge}
          <button onclick="loadAnalysisById(${analysis.id})" 
                  class="btn btn-primary" 
                  style="margin-top: 12px; padding: 8px 16px; font-size: 13px; width: 100%;">
            🔄 Cargar análisis
          </button>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error('Error cargando historial:', error);
    sidebarContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">❌</div>
        <h3>Error al cargar</h3>
        <p>Intenta de nuevo más tarde</p>
      </div>
    `;
    showNotification('Error cargando historial', 'error');
  }
}

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }

    function escapeHtml(text) {
      if(!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function checkCredits() {
      if (userCredits <= 0) {
        showNotification('No tienes créditos disponibles. Mejora tu plan para continuar.', 'error');
        return false;
      }
      return true;
    }

    function showProgress(show = true, text = 'Procesando...', percent = 0, subTask = '') {
      const container = document.getElementById('progressContainer');
      const fill = document.getElementById('progressFill');
      const textEl = document.getElementById('progressText');
      const subTaskEl = document.getElementById('progressSubTask');
      
      if (container && fill && textEl) {
        if (show) {
          container.style.display = 'block';
          fill.style.width = percent + '%';
          textEl.textContent = text;
          
          if (subTask) {
            subTaskEl.textContent = subTask;
            subTaskEl.style.display = 'block';
          } else {
            subTaskEl.style.display = 'none';
          }
        } else {
          container.style.display = 'none';
          subTaskEl.style.display = 'none';
        }
      }
    }

    function setupRealTimeValidation() {
      const inputs = ['niche', 'description', 'contentType', 'tone'];
      
      inputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
          element.addEventListener('blur', function() {
            validateSingleField(this.id);
          });
        }
      });
    }

    function validateSingleField(fieldId) {
      const element = document.getElementById(fieldId);
      if (!element) return;
      
      element.classList.remove('validation-error', 'validation-success');
      
      switch(fieldId) {
        case 'niche':
          if (element.value && element.value.length < 2) {
            element.classList.add('validation-error');
          } else if (element.value) {
            element.classList.add('validation-success');
          }
          break;
        case 'description':
          if (element.value && element.value.length < 10) {
            element.classList.add('validation-error');
          } else if (element.value) {
            element.classList.add('validation-success');
          }
          break;
        case 'contentType':
        case 'tone':
          if (!element.value) {
            element.classList.add('validation-error');
          } else {
            element.classList.add('validation-success');
          }
          break;
      }
    }

    function validateInputs() {
  const niche = document.getElementById('niche').value.trim();
  const description = document.getElementById('description').value.trim();
  const tone = document.getElementById('tone').value;
  const contentType = document.getElementById('contentType').value;
  
  const errors = [];
  const warnings = [];
  
  const hasUploadedFiles = uploadedFiles.length > 0;
  
  console.log('🔍 Validando inputs:', {
    niche: niche || '(vacío)',
    description: description ? `${description.substring(0, 30)}...` : '(vacío)',
    tone,
    contentType,
    hasFiles: hasUploadedFiles,
    filesCount: uploadedFiles.length
  });
  
  // ✅ PASO 1: Validar OBLIGATORIOS PRIMERO (tone y contentType)
  if (!contentType || contentType === '') {
    errors.push('❌ Selecciona un tipo de contenido');
    document.getElementById('contentType').classList.add('validation-error');
  } else {
    document.getElementById('contentType').classList.remove('validation-error');
    document.getElementById('contentType').classList.add('validation-success');
  }
  
  if (!tone || tone === '') {
    errors.push('❌ Selecciona un tono de comunicación');
    document.getElementById('tone').classList.add('validation-error');
  } else {
    document.getElementById('tone').classList.remove('validation-error');
    document.getElementById('tone').classList.add('validation-success');
  }
  
  // ⚠️ Si hay errores en obligatorios, DETENER aquí y mostrar error
  if (errors.length > 0) {
    showNotification(errors.join(' • '), 'error');
    return false;
  }
  
  // ✅ PASO 2: Validar CONTENIDO (después de validar obligatorios)
  if (!hasUploadedFiles && !niche && !description) {
    // Sin archivos y sin texto: ERROR
    errors.push('❌ Debes proporcionar: nicho, descripción o archivos multimedia');
    document.getElementById('niche').classList.add('validation-error');
    document.getElementById('description').classList.add('validation-error');
  } else {
    // Limpiar errores previos
    document.getElementById('niche').classList.remove('validation-error');
    document.getElementById('description').classList.remove('validation-error');
    
    // Validar calidad del texto si existe
    if (niche) {
      if (niche.length < 2) {
        errors.push('El nicho debe tener al menos 2 caracteres');
        document.getElementById('niche').classList.add('validation-error');
      } else {
        document.getElementById('niche').classList.add('validation-success');
      }
    }
    
    if (description) {
      if (description.length < 10) {
        errors.push('La descripción es muy corta (mínimo 10 caracteres)');
        document.getElementById('description').classList.add('validation-error');
      } else {
        document.getElementById('description').classList.add('validation-success');
      }
    }
    
    // ✅ WARNINGS ÚTILES (no son errores)
    if (hasUploadedFiles && !description) {
      warnings.push(`💡 TIP: Agrega una descripción para guiar mejor el contenido generado desde los ${uploadedFiles.length} archivo(s)`);
    }
    
    if (hasUploadedFiles && description) {
      console.log('✅ MODO ÓPTIMO: Descripción + Archivos multimedia');
    }
  }
  
  // ✅ PASO 3: Mostrar resultados (solo después de validar TODO)
  if (errors.length > 0) {
    showNotification(errors.join(' • '), 'error');
    return false;
  }
  
  // ✅ Mensaje de éxito personalizado
  let successMsg = '✅ Validación correcta. ';
  
  if (hasUploadedFiles && description) {
    successMsg += `Modo óptimo: ${uploadedFiles.length} archivo(s) + tu descripción.`;
  } else if (hasUploadedFiles) {
    successMsg += `${uploadedFiles.length} archivo(s) listos para procesar.`;
  } else if (description) {
    successMsg += 'Tu descripción está lista para generar contenido.';
  } else if (niche) {
    successMsg += 'Nicho configurado correctamente.';
  }
  
  showNotification(successMsg, 'success');
  
  // Mostrar tips como notificación separada (después de 2 segundos)
  if (warnings.length > 0) {
    setTimeout(() => {
      showNotification(warnings.join(' '), 'success');
    }, 2000);
  }
  
  return true;
}

    function scrollSlider(sliderId, direction) {
      const slider = document.getElementById(sliderId);
      if(!slider) return;
      
      const cardWidth = 296;
      const scrollAmount = cardWidth * direction;
      
      slider.scrollBy({
        left: scrollAmount,
        behavior: 'smooth'
      });
    }

    function selectPlan(plan) {
      currentPlan = plan;
      document.getElementById('selectedPlan').value = plan;
      
      if (plan === 'free') {
        authMode = 'register';
        document.getElementById('plansScreen').classList.add('hidden');
        document.getElementById('authScreen').classList.remove('hidden');
        updateAuthUI();
      } else {
        joinWaitlist(plan);
      }
    }
    
    async function joinWaitlist(plan) {
      const email = prompt(`Ingresa tu email para unirte a la lista de espera del plan ${plan.toUpperCase()}:`);
      
      if (!email) return;
      
      if (!validateEmail(email)) {
        showNotification('Email inválido', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/auth/waitlist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, plan })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error al unirse a la lista de espera');
        }
        
        showNotification(`¡Te has unido a la lista de espera! Te notificaremos cuando ${plan.toUpperCase()} esté disponible.`, 'success');
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }
    
    function toggleAuthMode() {
      authMode = authMode === 'login' ? 'register' : 'login';
      updateAuthUI();
    }
    
    function updateAuthUI() {
      const isLogin = authMode === 'login';
      document.getElementById('authTitle').textContent = isLogin ? 'Iniciar Sesión' : 'Crear Cuenta';
      document.getElementById('authBtnText').textContent = isLogin ? 'Iniciar Sesión' : 'Registrarse';
      document.getElementById('authToggleText').textContent = isLogin ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión';
    }
    
    async function handleAuth(event) {
      event.preventDefault();
      
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      const plan = document.getElementById('selectedPlan').value;
      
      if (!validateEmail(email)) {
        showNotification('Email inválido', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      const btn = document.getElementById('authSubmitBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Procesando...';
      
      try {
        const endpoint = authMode === 'login' ? '/auth/login' : '/auth/register';
        const response = await fetch(`${API_URL}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email, 
            password, 
            plan_type: plan 
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error en la autenticación');
        }
        
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        currentUser = data.user;
        userCredits = data.user.credits_remaining;
        
        if (authMode === 'register') {
          showNotification('¡Cuenta creada exitosamente!', 'success');
        } else {
          showNotification('¡Bienvenido de nuevo!', 'success');
        }
        
        showMainApp();
        
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<span id="authBtnText">${authMode === 'login' ? 'Iniciar Sesión' : 'Registrarse'}</span>`;
      }
    }
    
async function showForgotPassword() {
  const email = prompt('Ingresa tu email para recuperar tu contraseña:');
  
  if (!email) return;
  
  if (!validateEmail(email)) {
    showNotification('Email inválido', 'error');
    return;
  }
  
  console.log('🔄 Enviando solicitud de reset a:', `${API_URL}/auth/forgot-password`);
  console.log('📧 Email:', email);
  
  try {
    const response = await fetch(`${API_URL}/auth/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    console.log('📡 Respuesta del servidor:', response.status);
    
    const data = await response.json();
    console.log('📦 Data recibida:', data);
    
    if (!response.ok) {
      throw new Error(data.error || 'Error en el servidor');
    }
    
    showNotification('✅ Si el email existe, recibirás instrucciones para resetear tu contraseña', 'success');
  } catch (error) {
    console.error('❌ Error:', error);
    showNotification('Error: ' + error.message, 'error');
  }
}
    
function showMainApp() {
  document.getElementById('plansScreen').classList.add('hidden');
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('userPanel').style.display = 'block';
  document.getElementById('mainApp').classList.remove('hidden');
  
  // ✅ MOSTRAR BOTÓN FLOTANTE DEL SIDEBAR
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  if (sidebarToggleBtn) {
    sidebarToggleBtn.classList.add('active');
  }
  
  updateUserPanel();
  setupRealTimeValidation();
}
    
    function updateUserPanel() {
  if (!currentUser) return;
  
  document.getElementById('userEmail').textContent = currentUser.email;
  document.getElementById('userCredits').textContent = userCredits;
  document.getElementById('userPlan').textContent = currentUser.plan_type.toUpperCase();
  
  // ✅ MOSTRAR BOTÓN ADMIN SI EL USUARIO ES ADMINISTRADOR
  if (currentUser.is_admin) {
    const adminBtn = document.getElementById('adminBtn');
    if (adminBtn) {
      adminBtn.style.display = 'inline-block';
    }
  }
}
    
    function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  currentUser = null;
  uploadedFiles = [];
  currentResults = null;
  userCredits = 5;
  
  document.getElementById('userPanel').style.display = 'none';
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('resultsSection').classList.add('hidden');
  document.getElementById('plansScreen').classList.remove('hidden');
  
  // ✅ OCULTAR BOTÓN FLOTANTE Y ADMIN AL CERRAR SESIÓN
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  const adminBtn = document.getElementById('adminBtn');
  
  if (sidebarToggleBtn) sidebarToggleBtn.classList.remove('active');
  if (adminBtn) adminBtn.style.display = 'none';
  
  // Cerrar sidebar si está abierto
  closeSidebar();
  
  clearForm();
  showNotification('Sesión cerrada correctamente', 'success');
}

    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      
      if (files.length === 0) return;
      if (files.length > 10) {
        showNotification('Máximo 10 archivos permitidos', 'error');
        return;
      }
      
      uploadFiles(files);
    }
    
    async function uploadFiles(files) {
      const token = localStorage.getItem('token');
      if (!token) {
        showNotification('Debes iniciar sesión primero', 'error');
        return;
      }
      
      showProgress(true, 'Subiendo archivos...', 10, `Preparando ${files.length} archivo(s)`);
      
      try {
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));
        
        showProgress(true, 'Procesando archivos en el servidor...', 30, 'OCR + Transcripción automática');
        
        const response = await fetch(`${API_URL}/files/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error subiendo archivos');
        }
        
        uploadedFiles = data.files;
        renderFilePreview(files);
        
        showProgress(true, '¡Archivos procesados!', 100, `${data.processing_summary.successful} procesados exitosamente`);
        
        setTimeout(() => {
          showProgress(false);
          showNotification(`${files.length} archivo(s) subido(s) y procesados correctamente`, 'success');
        }, 1500);
        
      } catch (error) {
        showNotification(error.message, 'error');
        showProgress(false);
      }
    }
    
    function renderFilePreview(files) {
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';
      
      files.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-preview-item';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          item.appendChild(img);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.controls = true;
          item.appendChild(video);
        } else if (file.type.startsWith('audio/')) {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%;background:var(--bg-light);color:white;font-size:32px;';
          div.textContent = '🎵';
          item.appendChild(div);
        }
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'file-preview-remove';
        removeBtn.textContent = '×';
        removeBtn.onclick = () => removeFile(index);
        item.appendChild(removeBtn);
        
        preview.appendChild(item);
      });
    }
    
    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      const preview = document.getElementById('filePreview');
      if (preview.children[index]) {
        preview.children[index].remove();
      }
    }

    async function generateContent(event) {
      event.preventDefault();
      
      const token = localStorage.getItem('token');
      if (!token) {
        showNotification('Debes iniciar sesión primero', 'error');
        return;
      }
      
      if (!checkCredits()) return;
      if (!validateInputs()) return;
      
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Generando...';
      
      showProgress(true, 'Iniciando generación de contenido...', 10);
      
      try {
        const niche = document.getElementById('niche').value.trim();
        const description = document.getElementById('description').value.trim();
        
        const fileIds = uploadedFiles.map(f => f.id);
        
        showProgress(true, 'Generando contenido con IA...', 60, 'El backend está procesando archivos y generando contenido');
        
        const payload = {
          niche: niche,
          title: document.getElementById('title').value.trim(),
          description: description,
          tone: document.getElementById('tone').value,
          contentType: document.getElementById('contentType').value,
          files: fileIds
        };
        
        console.log('Enviando a /api/analyze:', payload);
        
        const response = await fetch(`${API_URL}/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error generando contenido');
        }
        
        currentResults = data.analysis;
        userCredits = data.credits_remaining;
        
        const transcriptionContent = document.getElementById('transcriptionContent');
        if (transcriptionContent && data.analysis.transcription) {
          transcriptionContent.innerHTML = `<strong>Textos Extraídos por el Servidor:</strong><br><br>${escapeHtml(data.analysis.transcription)}`;
        } else if (transcriptionContent) {
          transcriptionContent.innerHTML = 'No se procesaron archivos multimedia en este análisis.';
        }
        
        showProgress(true, 'Renderizando resultados...', 95);
        renderResults(data.analysis);
        
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('resultsSection').classList.remove('hidden');
        
        updateUserPanel();
        showNotification('¡Contenido generado exitosamente!', 'success');
        
        setTimeout(() => {
          document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
        
      } catch (error) {
        showNotification(error.message, 'error');
        console.error('Error:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>✨ Generar Contenido</span>';
        showProgress(false);
      }
    }
    
    function renderResults(results) {
      renderChips('hooksContent', results.hooks);
      renderChips('ctasContent', results.ctas);
      
      const emojisDiv = document.getElementById('emojisContent');
      emojisDiv.innerHTML = (results.emojis || []).map(emoji => 
        `<span style="margin: 4px; display: inline-block; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">${emoji}</span>`
      ).join('');
      
      renderChips('hashtagsContent', results.hashtags);
      
      const captionsDiv = document.getElementById('captionsContent');
      captionsDiv.innerHTML = (results.captions || []).map((caption, i) => 
        `<div class="caption-item">
          <strong>Caption ${i + 1}:</strong><br>
          ${escapeHtml(caption)}
        </div>`
      ).join('');

      renderThumbnails(results.thumbnails);
      renderCarousel(results.carousel_slides);
      renderChips('storiesContent', results.stories);
      
      document.getElementById('seoContent').textContent = results.seo_analysis || 'No disponible';
    }
    
    function renderChips(containerId, items) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = (items || []).map(item => 
        `<span class="chip">${escapeHtml(item)}</span>`
      ).join('');
    }
    
    // ============================================
// 🎨 SISTEMA INTERACTIVO DE MINIATURAS Y CARRUSELES
// ============================================

// Variables globales
let selectedThumbnailIndex = 0;
let selectedCarouselIndex = 0;
let currentThumbnails = [];
let currentCarouselSlides = [];

// ============================================
// 📸 RENDERIZADO DE MINIATURAS (MEJORADO)
// ============================================
function renderThumbnails(thumbnails) {
  const container = document.getElementById('thumbnailsContent');
  if (!container) return;
  
  if (!thumbnails || thumbnails.length === 0) {
    container.innerHTML = '<p>No hay miniaturas generadas</p>';
    return;
  }
  
  currentThumbnails = thumbnails;
  selectedThumbnailIndex = 0; // Primera por defecto
  
  let html = `
    <div style="position: relative; width: 100%; margin: 16px 0;">
      <div style="display: flex; gap: 16px; overflow-x: auto; scroll-behavior: smooth; padding: 16px 0;" id="thumbnailSlider">
  `;
  
  // Renderizar miniaturas con botón de descarga
  thumbnails.forEach((thumb, index) => {
    const isSelected = index === selectedThumbnailIndex;
    html += `
      <div 
        id="thumbnail-${index}"
        onclick="selectThumbnail(${index})"
        style="
          min-width: 320px; 
          height: 320px; 
          background: ${thumb.background_gradient || 'linear-gradient(135deg, #667eea, #764ba2)'}; 
          border-radius: 16px; 
          padding: 24px; 
          color: white; 
          position: relative; 
          display: flex; 
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          box-shadow: ${isSelected ? '0 0 0 4px #8B5FBF, 0 12px 32px rgba(139,95,191,0.4)' : '0 12px 32px rgba(0,0,0,0.3)'};
          transition: all 0.3s ease;
          cursor: pointer;
          border: ${isSelected ? '3px solid #FFFFFF' : '3px solid transparent'};
        " 
        onmouseover="if(${index} !== selectedThumbnailIndex) this.style.transform='translateY(-8px) scale(1.02)'" 
        onmouseout="if(${index} !== selectedThumbnailIndex) this.style.transform='translateY(0) scale(1)'">
        
        <!-- Número de miniatura -->
        <div style="
          position: absolute; 
          top: 12px; 
          right: 12px; 
          background: rgba(0,0,0,0.3); 
          color: white; 
          width: 32px; 
          height: 32px; 
          border-radius: 50%; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          font-size: 14px; 
          font-weight: 600;
          backdrop-filter: blur(10px);
        ">${index + 1}</div>
        
        <!-- Botón descargar (miniatura) -->
        <button 
          onclick="event.stopPropagation(); downloadThumbnailImage(${index})"
          style="
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(44, 212, 164, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          "
          onmouseover="this.style.background='rgba(5, 150, 105, 1)'; this.style.transform='scale(1.05)'"
          onmouseout="this.style.background='rgba(44, 212, 164, 0.9)'; this.style.transform='scale(1)'"
        >
          📥 Descargar
        </button>
        
        <!-- Indicador de selección -->
        ${isSelected ? `
        <div style="
          position: absolute;
          bottom: 12px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255,255,255,0.9);
          color: #8B5FBF;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 11px;
          font-weight: 700;
          text-transform: uppercase;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        ">
          ✓ Seleccionada
        </div>
        ` : ''}
        
        <!-- Texto principal -->
        <div style="
          font-family: '${thumb.font_family || 'Arial Black'}', sans-serif; 
          font-size: ${thumb.font_size || '42px'}; 
          color: ${thumb.text_color || '#FFFFFF'};
          font-weight: 900;
          line-height: 1.1;
          text-shadow: 0 2px 8px rgba(0,0,0,0.3);
          margin-bottom: ${thumb.secondary_text ? '16px' : '0'};
          max-width: 100%;
        ">${escapeHtml(thumb.text || 'TEXTO')}</div>
        
        <!-- Texto secundario -->
        ${thumb.secondary_text ? `
        <div style="
          font-family: '${thumb.secondary_font || 'Arial'}', sans-serif; 
          font-size: ${thumb.secondary_size || '20px'}; 
          color: ${thumb.text_color || '#FFFFFF'};
          opacity: 0.9;
          text-shadow: 0 1px 4px rgba(0,0,0,0.3);
          max-width: 100%;
        ">${escapeHtml(thumb.secondary_text)}</div>
        ` : ''}
      </div>
    `;
  });
  
  html += `
      </div>
      <div class="slider-controls">
        <button class="slider-btn" onclick="scrollSlider('thumbnailSlider', -1)">‹</button>
        <button class="slider-btn" onclick="scrollSlider('thumbnailSlider', 1)">›</button>
      </div>
    </div>
  `;
  
  // Panel de especificaciones (solo la seleccionada)
  html += '<div id="thumbnailSpecsPanel"></div>';
  
  container.innerHTML = html;
  
  // Renderizar specs de la primera miniatura
  renderThumbnailSpecs(selectedThumbnailIndex);
}

// ============================================
// 🎯 SELECCIONAR MINIATURA
// ============================================
function selectThumbnail(index) {
  if (selectedThumbnailIndex === index) return;
  
  // Actualizar índice seleccionado
  const previousIndex = selectedThumbnailIndex;
  selectedThumbnailIndex = index;
  
  // Actualizar visuales de las miniaturas
  updateThumbnailVisuals(previousIndex, index);
  
  // Renderizar especificaciones de la nueva seleccionada
  renderThumbnailSpecs(index);
  
  console.log(`✅ Miniatura ${index + 1} seleccionada`);
}

// ============================================
// 🎨 ACTUALIZAR VISUALES DE MINIATURAS
// ============================================
function updateThumbnailVisuals(previousIndex, newIndex) {
  const previousThumb = document.getElementById(`thumbnail-${previousIndex}`);
  const newThumb = document.getElementById(`thumbnail-${newIndex}`);
  
  if (previousThumb) {
    // Quitar selección visual de la anterior
    previousThumb.style.boxShadow = '0 12px 32px rgba(0,0,0,0.3)';
    previousThumb.style.border = '3px solid transparent';
    
    // Quitar indicador "Seleccionada"
    const indicator = previousThumb.querySelector('[style*="Seleccionada"]')?.parentElement;
    if (indicator) indicator.remove();
  }
  
  if (newThumb) {
    // Agregar selección visual a la nueva
    newThumb.style.boxShadow = '0 0 0 4px #8B5FBF, 0 12px 32px rgba(139,95,191,0.4)';
    newThumb.style.border = '3px solid #FFFFFF';
    
    // Agregar indicador "Seleccionada"
    const indicator = document.createElement('div');
    indicator.style.cssText = `
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      color: #8B5FBF;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    indicator.textContent = '✓ Seleccionada';
    newThumb.appendChild(indicator);
  }
}

// ============================================
// 📋 RENDERIZAR ESPECIFICACIONES DE MINIATURA
// ============================================
function renderThumbnailSpecs(index) {
  const panel = document.getElementById('thumbnailSpecsPanel');
  if (!panel || !currentThumbnails[index]) return;
  
  const thumb = currentThumbnails[index];
  const colorScheme = thumb.background_gradient || 'linear-gradient(135deg, #667eea, #764ba2)';
  
  panel.innerHTML = `
    <div style="margin: 32px 0; padding: 24px; background: #f8fafc; border-radius: 16px; border-left: 6px solid #8B5FBF; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
      
      <!-- Header con botón de descarga -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h4 style="color: #8B5FBF; font-size: 20px; font-weight: 700; margin: 0;">
          📐 Especificaciones - Miniatura ${index + 1}
        </h4>
        <button 
          onclick="downloadThumbnailImage(${index})"
          class="btn btn-success"
          style="padding: 10px 20px; font-size: 14px;"
        >
          📥 Descargar PNG (1080x1350)
        </button>
      </div>
      
      <!-- Texto principal -->
      <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📝 Texto Principal</div>
        <div style="font-size: 18px; color: #1e40af; font-weight: 700; margin-bottom: 8px;">"${escapeHtml(thumb.text || '')}"</div>
      </div>
      
      <!-- Grid de especificaciones -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
        
        <!-- Tipografía Principal -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">🔤 Tipografía Principal</div>
          <div style="font-size: 14px; color: #374151;">Fuente: <strong>${thumb.font_family || 'No especificada'}</strong></div>
          <div style="font-size: 14px; color: #374151;">Tamaño: <strong>${thumb.font_size || 'No especificado'}</strong></div>
          <div style="font-size: 14px; color: #374151;">Color: <strong>${thumb.text_color || 'No especificado'}</strong></div>
        </div>
        
        ${thumb.secondary_text ? `
        <!-- Texto Secundario -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📝 Texto Secundario</div>
          <div style="font-size: 14px; color: #374151;">Fuente: <strong>${thumb.secondary_font || 'No especificada'}</strong></div>
          <div style="font-size: 14px; color: #374151;">Tamaño: <strong>${thumb.secondary_size || 'No especificado'}</strong></div>
          <div style="font-size: 14px; color: #374151; margin-top: 8px;">"${escapeHtml(thumb.secondary_text)}"</div>
        </div>
        ` : ''}
        
        <!-- Fondo -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">🎨 Fondo</div>
          <div style="font-size: 14px; color: #374151; margin-bottom: 8px;">Gradiente CSS:</div>
          <div style="height: 40px; background: ${colorScheme}; border-radius: 8px; margin-bottom: 8px;"></div>
          <div style="font-size: 12px; color: #6b7280; word-break: break-all;">${colorScheme}</div>
        </div>
      </div>
      
      ${thumb.image_suggestion ? `
      <!-- Imagen Recomendada -->
      <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📷 Imagen Recomendada</div>
        <div style="font-size: 14px; color: #374151; line-height: 1.6;">${escapeHtml(thumb.image_suggestion)}</div>
      </div>
      ` : ''}
      
      ${thumb.layout ? `
      <!-- Layout -->
      <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
        <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📐 Layout y Composición</div>
        <div style="font-size: 14px; color: #374151; line-height: 1.6;">${escapeHtml(thumb.layout)}</div>
      </div>
      ` : ''}
      
    </div>
  `;
}

// ============================================
// 📥 DESCARGAR MINIATURA COMO PNG EXTENDIDO (1080x2400)
// ============================================
async function downloadThumbnailImage(index) {
  if (!currentThumbnails[index]) {
    showNotification('Error: Miniatura no encontrada', 'error');
    return;
  }
  
  const thumb = currentThumbnails[index];
  
  try {
    showNotification('⏳ Generando PNG extendido...', 'success');
    
    // Crear canvas EXTENDIDO (1080x2400 para incluir especificaciones)
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 2400; // ⬅️ MÁS ALTO para incluir specs
    const ctx = canvas.getContext('2d');
    
    // ========================================
    // PARTE 1: MINIATURA VISUAL (0-1350px)
    // ========================================
    
    // Fondo con gradiente
    const gradient = parseGradient(thumb.background_gradient || 'linear-gradient(135deg, #667eea, #764ba2)');
    const grd = ctx.createLinearGradient(0, 0, 1080, 1350);
    grd.addColorStop(0, gradient.color1);
    grd.addColorStop(1, gradient.color2);
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, 1080, 1350);
    
    // Texto principal
    ctx.fillStyle = thumb.text_color || '#FFFFFF';
    ctx.font = `900 ${parseInt(thumb.font_size || '42') * 2}px ${thumb.font_family || 'Arial Black'}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 4;
    
    const maxWidth = 900;
    const lines = wrapText(ctx, thumb.text || 'TEXTO', maxWidth);
    const lineHeight = parseInt(thumb.font_size || '42') * 2.2;
    const startY = thumb.secondary_text ? 550 : 675;
    
    lines.forEach((line, i) => {
      ctx.fillText(line, 540, startY + (i * lineHeight));
    });
    
    // Texto secundario
    if (thumb.secondary_text) {
      ctx.font = `600 ${parseInt(thumb.secondary_size || '20') * 2}px ${thumb.secondary_font || 'Arial'}`;
      ctx.globalAlpha = 0.9;
      const secondaryLines = wrapText(ctx, thumb.secondary_text, maxWidth);
      const secondaryStartY = startY + (lines.length * lineHeight) + 40;
      
      secondaryLines.forEach((line, i) => {
        ctx.fillText(line, 540, secondaryStartY + (i * (parseInt(thumb.secondary_size || '20') * 2.2)));
      });
    }
    
    // Número de miniatura
    ctx.globalAlpha = 1;
    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    ctx.beginPath();
    ctx.arc(980, 80, 40, 0, 2 * Math.PI);
    ctx.fill();
    
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '700 36px Arial';
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.fillText((index + 1).toString(), 980, 85);
    
    // ========================================
    // PARTE 2: ESPECIFICACIONES (1350-2400px)
    // ========================================
    
    let y = 1380; // Empezar debajo de la miniatura
    
    // Fondo blanco para especificaciones
    ctx.fillStyle = '#F8FAFC';
    ctx.fillRect(0, 1350, 1080, 1050);
    
    // Título de especificaciones
    ctx.fillStyle = '#8B5FBF';
    ctx.fillRect(40, y, 1000, 60);
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '700 36px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`📐 Especificaciones - Miniatura ${index + 1}`, 60, y + 42);
    
    y += 90;
    
    // Texto Principal
    ctx.fillStyle = '#3B82F6';
    ctx.font = '600 28px Arial';
    ctx.fillText('📝 Texto Principal:', 60, y);
    y += 40;
    
    ctx.fillStyle = '#1E40AF';
    ctx.font = '700 32px Arial';
    const textLines = wrapText(ctx, `"${thumb.text || ''}"`, 960);
    textLines.forEach(line => {
      ctx.fillText(line, 60, y);
      y += 40;
    });
    
    y += 20;
    
    // Tipografía Principal
    ctx.fillStyle = '#3B82F6';
    ctx.font = '600 28px Arial';
    ctx.fillText('🔤 Tipografía Principal:', 60, y);
    y += 40;
    
    ctx.fillStyle = '#374151';
    ctx.font = '400 24px Arial';
    ctx.fillText(`Fuente: ${thumb.font_family || 'No especificada'}`, 80, y);
    y += 35;
    ctx.fillText(`Tamaño: ${thumb.font_size || 'No especificado'}`, 80, y);
    y += 35;
    ctx.fillText(`Color: ${thumb.text_color || 'No especificado'}`, 80, y);
    y += 50;
    
    // Texto Secundario (si existe)
    if (thumb.secondary_text) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('📝 Texto Secundario:', 60, y);
      y += 40;
      
      ctx.fillStyle = '#374151';
      ctx.font = '400 24px Arial';
      ctx.fillText(`Fuente: ${thumb.secondary_font || 'No especificada'}`, 80, y);
      y += 35;
      ctx.fillText(`Tamaño: ${thumb.secondary_size || 'No especificado'}`, 80, y);
      y += 35;
      
      const secLines = wrapText(ctx, `"${thumb.secondary_text}"`, 920);
      secLines.forEach(line => {
        ctx.fillText(line, 80, y);
        y += 35;
      });
      y += 20;
    }
    
    // Fondo/Gradiente
    ctx.fillStyle = '#3B82F6';
    ctx.font = '600 28px Arial';
    ctx.fillText('🎨 Fondo:', 60, y);
    y += 40;
    
    // Dibujar preview del gradiente
    const gradPreview = parseGradient(thumb.background_gradient || 'linear-gradient(135deg, #667eea, #764ba2)');
    const grdPreview = ctx.createLinearGradient(80, y, 500, y);
    grdPreview.addColorStop(0, gradPreview.color1);
    grdPreview.addColorStop(1, gradPreview.color2);
    ctx.fillStyle = grdPreview;
    ctx.fillRect(80, y, 420, 60);
    
    y += 80;
    
    ctx.fillStyle = '#6B7280';
    ctx.font = '400 20px Arial';
    const gradText = thumb.background_gradient || 'linear-gradient(135deg, #667eea, #764ba2)';
    const gradLines = wrapText(ctx, gradText, 960);
    gradLines.forEach(line => {
      ctx.fillText(line, 60, y);
      y += 28;
    });
    
    y += 30;
    
    // Imagen Recomendada
    if (thumb.image_suggestion && y < 2300) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('📷 Imagen Recomendada:', 60, y);
      y += 40;
      
      ctx.fillStyle = '#374151';
      ctx.font = '400 24px Arial';
      const imgLines = wrapText(ctx, thumb.image_suggestion, 960);
      imgLines.forEach(line => {
        if (y < 2350) {
          ctx.fillText(line, 80, y);
          y += 32;
        }
      });
    }
    
    // Footer con marca
    ctx.fillStyle = '#8B5FBF';
    ctx.font = '600 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Conteniza.com - Generado con IA', 540, 2360);
    
    // Descargar
    const link = document.createElement('a');
    link.download = `Conteniza_Miniatura_Extendida_${index + 1}_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    showNotification('✅ PNG extendido descargado exitosamente', 'success');
    
  } catch (error) {
    console.error('Error generando PNG extendido:', error);
    showNotification('Error al generar PNG extendido', 'error');
  }
}
// ============================================
// 🎠 RENDERIZADO DE CARRUSEL (MEJORADO)
// ============================================
function renderCarousel(slides) {
  const container = document.getElementById('carouselSlides');
  const carouselContent = document.getElementById('carouselContent');
  
  if (!container || !carouselContent) return;
  
  if (!slides || slides.length === 0) {
    carouselContent.innerHTML = '<p>No hay slides de carrusel generados</p>';
    return;
  }
  
  currentCarouselSlides = slides;
  selectedCarouselIndex = 0; // Primer slide por defecto
  
  const colors = [
    'linear-gradient(135deg, #8B5FBF, #FF6B9D)',
    'linear-gradient(135deg, #6ECBF5, #2CD4A4)',
    'linear-gradient(135deg, #FFA36B, #FF6B6B)',
    'linear-gradient(135deg, #8B5FBF, #6ECBF5)',
    'linear-gradient(135deg, #FF6B9D, #FFA36B)',
    'linear-gradient(135deg, #2CD4A4, #8B5FBF)',
    'linear-gradient(135deg, #6ECBF5, #FF6B9D)',
    'linear-gradient(135deg, #FFA36B, #2CD4A4)'
  ];
  
  // Renderizar slides visuales con botón de descarga
  container.innerHTML = slides.map((slide, i) => {
    const isSelected = i === selectedCarouselIndex;
    return `
      <div 
        id="carousel-slide-${i}"
        class="carousel-slide" 
        onclick="selectCarouselSlide(${i})"
        style="
          background: ${colors[i % colors.length]};
          cursor: pointer;
          box-shadow: ${isSelected ? '0 0 0 4px #8B5FBF, 0 12px 40px rgba(139,95,191,0.4)' : '0 8px 32px rgba(0,0,0,0.2)'};
          border: ${isSelected ? '3px solid #FFFFFF' : '3px solid transparent'};
          transition: all 0.3s ease;
        "
        onmouseover="if(${i} !== selectedCarouselIndex) this.style.transform='translateY(-4px)'"
        onmouseout="if(${i} !== selectedCarouselIndex) this.style.transform='translateY(0)'">
        
        <div class="carousel-slide-number">${i + 1}</div>
        
        <!-- Botón descargar (slide) -->
        <button 
          onclick="event.stopPropagation(); downloadCarouselSlideImage(${i})"
          style="
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(44, 212, 164, 0.9);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 10;
          "
          onmouseover="this.style.background='rgba(5, 150, 105, 1)'; this.style.transform='scale(1.05)'"
          onmouseout="this.style.background='rgba(44, 212, 164, 0.9)'; this.style.transform='scale(1)'"
        >
          📥
        </button>
        
        ${isSelected ? `
        <div style="
          position: absolute;
          bottom: 12px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255,255,255,0.9);
          color: #8B5FBF;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 10px;
          font-weight: 700;
          text-transform: uppercase;
        ">
          ✓ Seleccionado
        </div>
        ` : ''}
        
        <div>
          <h4>${escapeHtml(slide.title || '')}</h4>
          <p>${escapeHtml(slide.content || '')}</p>
        </div>
      </div>
    `;
  }).join('');
  
  // Limpiar especificaciones previas
  const existingSpecs = carouselContent.querySelector('.carousel-specs');
  if (existingSpecs) existingSpecs.remove();
  
  // Crear panel de especificaciones
  const specsPanel = document.createElement('div');
  specsPanel.className = 'carousel-specs';
  specsPanel.id = 'carouselSpecsPanel';
  carouselContent.appendChild(specsPanel);
  
  // Renderizar specs del primer slide
  renderCarouselSlideSpecs(selectedCarouselIndex);
}

// ============================================
// 🎯 SELECCIONAR SLIDE DE CARRUSEL
// ============================================
function selectCarouselSlide(index) {
  if (selectedCarouselIndex === index) return;
  
  const previousIndex = selectedCarouselIndex;
  selectedCarouselIndex = index;
  
  // Actualizar visuales de los slides
  updateCarouselSlideVisuals(previousIndex, index);
  
  // Renderizar especificaciones del nuevo slide
  renderCarouselSlideSpecs(index);
  
  console.log(`✅ Slide ${index + 1} seleccionado`);
}

// ============================================
// 🎨 ACTUALIZAR VISUALES DE SLIDES
// ============================================
function updateCarouselSlideVisuals(previousIndex, newIndex) {
  const previousSlide = document.getElementById(`carousel-slide-${previousIndex}`);
  const newSlide = document.getElementById(`carousel-slide-${newIndex}`);
  
  if (previousSlide) {
    previousSlide.style.boxShadow = '0 8px 32px rgba(0,0,0,0.2)';
    previousSlide.style.border = '3px solid transparent';
    
    const indicator = previousSlide.querySelector('[style*="Seleccionado"]')?.parentElement;
    if (indicator) indicator.remove();
  }
  
  if (newSlide) {
    newSlide.style.boxShadow = '0 0 0 4px #8B5FBF, 0 12px 40px rgba(139,95,191,0.4)';
    newSlide.style.border = '3px solid #FFFFFF';
    
    const indicator = document.createElement('div');
    indicator.style.cssText = `
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      color: #8B5FBF;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    `;
    indicator.textContent = '✓ Seleccionado';
    newSlide.appendChild(indicator);
  }
}

// ============================================
// 📋 RENDERIZAR ESPECIFICACIONES DE SLIDE
// ============================================
function renderCarouselSlideSpecs(index) {
  const panel = document.getElementById('carouselSpecsPanel');
  if (!panel || !currentCarouselSlides[index]) return;
  
  const slide = currentCarouselSlides[index];
  const colors = [
    'linear-gradient(135deg, #8B5FBF, #FF6B9D)',
    'linear-gradient(135deg, #6ECBF5, #2CD4A4)',
    'linear-gradient(135deg, #FFA36B, #FF6B6B)',
    'linear-gradient(135deg, #8B5FBF, #6ECBF5)',
    'linear-gradient(135deg, #FF6B9D, #FFA36B)',
    'linear-gradient(135deg, #2CD4A4, #8B5FBF)',
    'linear-gradient(135deg, #6ECBF5, #FF6B9D)',
    'linear-gradient(135deg, #FFA36B, #2CD4A4)'
  ];
  const colorScheme = slide.color_scheme || colors[index % colors.length];
  
  panel.innerHTML = `
    <h4 style="margin: 32px 0 16px; color: #8B5FBF; font-size: 20px; font-weight: 700;">
      📐 Especificaciones del Slide ${index + 1} de 8
    </h4>
    
    <div style="margin-bottom: 24px; padding: 24px; background: #f8fafc; border-radius: 16px; border-left: 6px solid #8B5FBF; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
      
      <!-- Header con botón de descarga -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <h5 style="color: #1e40af; font-size: 18px; font-weight: 700; margin: 0;">
          ${escapeHtml(slide.title || `Slide ${index + 1}`)}
        </h5>
        <button 
          onclick="downloadCarouselSlideImage(${index})"
          class="btn btn-success"
          style="padding: 10px 20px; font-size: 14px;"
        >
          📥 Descargar PNG (1080x1350)
        </button>
      </div>
      
      <!-- Contenido del slide -->
      <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📝 Contenido</div>
<div style="font-size: 14px; color: #374151; line-height: 1.6;">${escapeHtml(slide.content || '')}</div>
      </div>
      
      ${slide.exact_text ? `
      <!-- Texto exacto -->
      <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; border: 1px solid #bbf7d0; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #15803d; margin-bottom: 8px;">✏️ Texto Exacto para Copiar</div>
        <div style="font-size: 14px; color: #166534; line-height: 1.6; font-style: italic;">"${escapeHtml(slide.exact_text)}"</div>
      </div>
      ` : ''}
      
      <!-- Grid de especificaciones -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
        
        <!-- Esquema de color -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">🎨 Esquema de Color</div>
          <div style="height: 40px; background: ${colorScheme}; border-radius: 8px; margin-bottom: 8px;"></div>
          <div style="font-size: 12px; color: #6b7280; word-break: break-all;">${colorScheme}</div>
        </div>
        
        <!-- Recomendaciones tipográficas -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">🔤 Tipografía</div>
          <div style="font-size: 14px; color: #374151;">
            • Título: <strong>Montserrat Bold, 36-42px</strong><br>
            • Contenido: <strong>Inter Regular, 18-22px</strong><br>
            • Color: <strong>Blanco con sombra</strong>
          </div>
        </div>
        
        ${slide.emoji_usage ? `
        <!-- Emojis -->
        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">😊 Emojis Recomendados</div>
          <div style="font-size: 24px;">${escapeHtml(slide.emoji_usage)}</div>
        </div>
        ` : ''}
      </div>
      
      ${slide.image_suggestion ? `
      <!-- Imagen sugerida -->
      <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
        <div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px;">📷 Imagen Sugerida</div>
        <div style="font-size: 14px; color: #374151; line-height: 1.6;">${escapeHtml(slide.image_suggestion)}</div>
      </div>
      ` : ''}
      
    </div>
  `;
}

// ============================================
// 📥 DESCARGAR SLIDE DE CARRUSEL COMO PNG EXTENDIDO (1080x2400)
// ============================================
async function downloadCarouselSlideImage(index) {
  if (!currentCarouselSlides[index]) {
    showNotification('Error: Slide no encontrado', 'error');
    return;
  }
  
  const slide = currentCarouselSlides[index];
  
  try {
    showNotification('⏳ Generando PNG extendido del slide...', 'success');
    
    const colors = [
      'linear-gradient(135deg, #8B5FBF, #FF6B9D)',
      'linear-gradient(135deg, #6ECBF5, #2CD4A4)',
      'linear-gradient(135deg, #FFA36B, #FF6B6B)',
      'linear-gradient(135deg, #8B5FBF, #6ECBF5)',
      'linear-gradient(135deg, #FF6B9D, #FFA36B)',
      'linear-gradient(135deg, #2CD4A4, #8B5FBF)',
      'linear-gradient(135deg, #6ECBF5, #FF6B9D)',
      'linear-gradient(135deg, #FFA36B, #2CD4A4)'
    ];
    
    // Crear canvas EXTENDIDO (1080x2400)
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 2400;
    const ctx = canvas.getContext('2d');
    
    // ========================================
    // PARTE 1: SLIDE VISUAL (0-1350px)
    // ========================================
    
    const gradientStr = slide.color_scheme || colors[index % colors.length];
    const gradient = parseGradient(gradientStr);
    const grd = ctx.createLinearGradient(0, 0, 1080, 1350);
    grd.addColorStop(0, gradient.color1);
    grd.addColorStop(1, gradient.color2);
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, 1080, 1350);
    
    // Número de slide (círculo arriba a la derecha)
    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.beginPath();
    ctx.arc(940, 100, 50, 0, 2 * Math.PI);
    ctx.fill();
    
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '700 48px Arial';
    ctx.textAlign = 'center';
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.fillText((index + 1).toString(), 940, 115);
    
    // Título
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '900 64px Montserrat, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
    ctx.shadowBlur = 12;
    ctx.shadowOffsetY = 6;
    
    const titleLines = wrapText(ctx, slide.title || `Slide ${index + 1}`, 950);
    let currentY = 250;
    titleLines.forEach(line => {
      ctx.fillText(line, 540, currentY);
      currentY += 80;
    });
    
    // Contenido
    currentY += 60;
    ctx.font = '400 42px Inter, Arial';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetY = 4;
    
    const contentLines = wrapText(ctx, slide.content || '', 900);
    contentLines.forEach(line => {
      if (currentY < 1250) {
        ctx.fillText(line, 540, currentY);
        currentY += 58;
      }
    });
    
    // ========================================
    // PARTE 2: ESPECIFICACIONES (1350-2400px)
    // ========================================
    
    let y = 1380;
    
    // Fondo blanco para especificaciones
    ctx.fillStyle = '#F8FAFC';
    ctx.fillRect(0, 1350, 1080, 1050);
    
    // Título de especificaciones
    ctx.fillStyle = '#8B5FBF';
    ctx.fillRect(40, y, 1000, 60);
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '700 36px Arial';
    ctx.textAlign = 'left';
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.fillText(`📐 Especificaciones - Slide ${index + 1} de 8`, 60, y + 42);
    
    y += 90;
    
    // Título del slide
    ctx.fillStyle = '#1E40AF';
    ctx.font = '700 32px Arial';
    const slideTitleLines = wrapText(ctx, slide.title || `Slide ${index + 1}`, 960);
    slideTitleLines.forEach(line => {
      ctx.fillText(line, 60, y);
      y += 40;
    });
    
    y += 30;
    
    // Contenido del slide
    ctx.fillStyle = '#3B82F6';
    ctx.font = '600 28px Arial';
    ctx.fillText('📝 Contenido:', 60, y);
    y += 40;
    
    ctx.fillStyle = '#374151';
    ctx.font = '400 24px Arial';
    const slideContentLines = wrapText(ctx, slide.content || '', 960);
    slideContentLines.forEach(line => {
      if (y < 2100) {
        ctx.fillText(line, 80, y);
        y += 32;
      }
    });
    
    y += 30;
    
    // Texto Exacto (si existe)
    if (slide.exact_text && y < 2100) {
      ctx.fillStyle = '#15803D';
      ctx.font = '600 28px Arial';
      ctx.fillText('✏️ Texto Exacto para Copiar:', 60, y);
      y += 40;
      
      ctx.fillStyle = '#166534';
      ctx.font = 'italic 24px Arial';
      const exactLines = wrapText(ctx, `"${slide.exact_text}"`, 960);
      exactLines.forEach(line => {
        if (y < 2120) {
          ctx.fillText(line, 80, y);
          y += 32;
        }
      });
      y += 30;
    }
    
    // Esquema de Color
    if (y < 2150) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('🎨 Esquema de Color:', 60, y);
      y += 40;
      
      // Preview del gradiente
      const colorScheme = slide.color_scheme || colors[index % colors.length];
      const gradPreview = parseGradient(colorScheme);
      const grdPreview = ctx.createLinearGradient(80, y, 500, y);
      grdPreview.addColorStop(0, gradPreview.color1);
      grdPreview.addColorStop(1, gradPreview.color2);
      ctx.fillStyle = grdPreview;
      ctx.fillRect(80, y, 420, 60);
      
      y += 80;
      
      ctx.fillStyle = '#6B7280';
      ctx.font = '400 20px Arial';
      const colorLines = wrapText(ctx, colorScheme, 960);
      colorLines.forEach(line => {
        if (y < 2180) {
          ctx.fillText(line, 60, y);
          y += 28;
        }
      });
      
      y += 30;
    }
    
    // Tipografía Recomendada
    if (y < 2200) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('🔤 Tipografía Recomendada:', 60, y);
      y += 40;
      
      ctx.fillStyle = '#374151';
      ctx.font = '400 24px Arial';
      ctx.fillText('• Título: Montserrat Bold, 36-42px', 80, y);
      y += 35;
      ctx.fillText('• Contenido: Inter Regular, 18-22px', 80, y);
      y += 35;
      ctx.fillText('• Color: Blanco con sombra', 80, y);
      y += 50;
    }
    
    // Emojis (si existen)
    if (slide.emoji_usage && y < 2250) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('😊 Emojis Recomendados:', 60, y);
      y += 40;
      
      ctx.font = '48px Arial';
      ctx.fillText(slide.emoji_usage, 80, y);
      y += 60;
    }
    
    // Imagen Sugerida (si existe y hay espacio)
    if (slide.image_suggestion && y < 2250) {
      ctx.fillStyle = '#3B82F6';
      ctx.font = '600 28px Arial';
      ctx.fillText('📷 Imagen Sugerida:', 60, y);
      y += 40;
      
      ctx.fillStyle = '#374151';
      ctx.font = '400 24px Arial';
      const imgLines = wrapText(ctx, slide.image_suggestion, 960);
      imgLines.forEach(line => {
        if (y < 2320) {
          ctx.fillText(line, 80, y);
          y += 32;
        }
      });
    }
    
    // Footer con marca
    ctx.fillStyle = '#8B5FBF';
    ctx.font = '600 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Conteniza.com - Carrusel de Instagram', 540, 2360);
    
    // Descargar
    const link = document.createElement('a');
    link.download = `Conteniza_Carrusel_Slide_${index + 1}_Extendido_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    showNotification(`✅ Slide ${index + 1} descargado exitosamente`, 'success');
    
  } catch (error) {
    console.error('Error generando PNG del slide:', error);
    showNotification('Error al generar PNG', 'error');
  }
}
// ============================================
// 🛠️ FUNCIONES AUXILIARES
// ============================================

function parseGradient(gradientStr) {
  const regex = /#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3}/g;
  const colors = gradientStr.match(regex) || ['#667eea', '#764ba2'];
  
  return {
    color1: colors[0] || '#667eea',
    color2: colors[1] || colors[0] || '#764ba2'
  };
}

function wrapText(ctx, text, maxWidth) {
  const words = text.split(' ');
  const lines = [];
  let currentLine = words[0];
  
  for (let i = 1; i < words.length; i++) {
    const word = words[i];
    const width = ctx.measureText(currentLine + ' ' + word).width;
    if (width < maxWidth) {
      currentLine += ' ' + word;
    } else {
      lines.push(currentLine);
      currentLine = word;
    }
  }
  lines.push(currentLine);
  
  return lines;
}
    
    
    function clearForm() {
      document.getElementById('contentForm').reset();
      document.getElementById('filePreview').innerHTML = '';
      uploadedFiles = [];
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('transcriptionContent').innerHTML = '';
      
      const elements = document.querySelectorAll('.validation-error, .validation-success');
      elements.forEach(el => el.classList.remove('validation-error', 'validation-success'));
    }
    
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.innerText || element.textContent;
      
      navigator.clipboard.writeText(text)
        .then(() => showNotification('Copiado al portapapeles', 'success'))
        .catch(() => showNotification('Error al copiar', 'error'));
    }
    
    async function showHistory() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      try {
        const response = await fetch(`${API_URL}/analyze`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.analyses && data.analyses.length > 0) {
          showNotification(`Tienes ${data.analyses.length} análisis en tu historial`, 'success');
        } else {
          showNotification('No tienes análisis previos', 'success');
        }
      } catch (error) {
        showNotification('Error cargando historial', 'error');
      }
    }

    function cleanTextForPDF(text) {
      if (!text) return '';
      
      const charMap = {
        'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u',
        'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U',
        'ñ': 'n', 'Ñ': 'N',
        'ü': 'u', 'Ü': 'U',
        '¿': '?', '¡': '!',
        '´': "'", '`': "'",
        '¨': '"', '°': ' ',
        'ª': 'a', 'º': 'o',
        '·': '.', '•': '-',
        '€': 'EUR', '£': 'GBP', '$': 'USD',
        '…': '...', '–': '-', '—': '-'
      };
      
      return String(text)
        .split('')
        .map(char => charMap[char] || char)
        .join('')
        .replace(/[^\x00-\x7F]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

async function generatePDF() {
  if (!window.jspdf) {
    showNotification('Librería PDF no disponible', 'error');
    return;
  }
  
  if (!currentResults) {
    showNotification('No hay resultados para exportar', 'error');
    return;
  }
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ✅ COLORES DE MARCA
    const colors = {
      primary: [139, 95, 191],
      secondary: [255, 107, 157],
      accent: [110, 203, 245],
      success: [44, 212, 164],
      text: [45, 55, 72],
      textLight: [113, 128, 150]
    };
    
    // ✅ AGREGAR LOGO
    const logo = await loadImageAsBase64('logo.jpg');
    if (logo) {
      doc.addImage(logo, 'JPEG', 15, 10, 25, 25);
    }
    
    // ✅ HEADER
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(24);
    doc.setTextColor(...colors.primary);
    doc.text('Conteniza', logo ? 45 : 20, 22);
    
    doc.setFontSize(10);
    doc.setTextColor(...colors.textLight);
    doc.text('Reporte de Analisis de Contenido', logo ? 45 : 20, 28);
    
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(15, 38, 195, 38);
    
    // Información del reporte
    let y = 48;
    doc.setFontSize(9);
    doc.setTextColor(...colors.text);
    doc.text(`Generado: ${new Date().toLocaleDateString('es-ES', {
      day: '2-digit',
      month: 'long', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })}`, 15, y);
    y += 6;
    
    doc.text(`Nicho: ${cleanTextForPDF(document.getElementById('niche').value || 'No especificado')}`, 15, y);
    y += 6;
    doc.text(`Tono: ${cleanTextForPDF(document.getElementById('tone').value || 'No especificado')}`, 15, y);
    y += 6;
    doc.text(`Tipo: ${cleanTextForPDF(document.getElementById('contentType').value || 'No especificado')}`, 15, y);
    y += 10;
    
    // ✅ FUNCIÓN PARA AGREGAR SECCIONES
    function addSection(title, content, isArray = false, maxLines = 50) {
      if (y > 250) {
        doc.addPage();
        y = 30;
      }
      
      doc.setFillColor(...colors.primary);
      doc.rect(15, y - 5, 180, 8, 'F');
      
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text(cleanTextForPDF(title), 18, y);
      y += 12;
      
      doc.setFontSize(9);
      doc.setTextColor(...colors.text);
      
      if (isArray && Array.isArray(content)) {
        let lineCount = 0;
        content.forEach((item) => {
          if (lineCount >= maxLines || y > 270) {
            doc.addPage();
            y = 30;
            lineCount = 0;
          }
          
          doc.setFillColor(...colors.accent);
          doc.circle(18, y - 1, 1, 'F');
          
          const cleanItem = cleanTextForPDF(item);
          const lines = doc.splitTextToSize(cleanItem, 165);
          
          lines.forEach((line) => {
            if (y > 270) {
              doc.addPage();
              y = 30;
              lineCount = 0;
            }
            doc.text(line, 23, y);
            y += 5;
            lineCount++;
          });
          y += 2;
        });
      } else if (content) {
        const cleanContent = cleanTextForPDF(String(content));
        const lines = doc.splitTextToSize(cleanContent, 175);
        
        lines.forEach(line => {
          if (y > 270) {
            doc.addPage();
            y = 30;
          }
          doc.text(line, 18, y);
          y += 5;
        });
      }
      y += 8;
    }
    
    // ✅ AGREGAR SECCIONES BÁSICAS
    addSection('HOOKS MAGNETICOS', currentResults.hooks, true);
    addSection('CALL-TO-ACTIONS', currentResults.ctas, true);
    addSection('HASHTAGS', currentResults.hashtags, true);
    
    // CAPTIONS
    if (currentResults.captions && currentResults.captions.length > 0) {
      if (y > 200) {
        doc.addPage();
        y = 30;
      }
      
      doc.setFillColor(...colors.secondary);
      doc.rect(15, y - 5, 180, 8, 'F');
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text('CAPTIONS OPTIMIZADOS', 18, y);
      y += 15;
      
      currentResults.captions.forEach((caption, index) => {
        if (y > 220) {
          doc.addPage();
          y = 30;
        }
        
        doc.setFillColor(...colors.primary);
        doc.circle(20, y - 2, 4, 'F');
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text(String(index + 1), 18.5, y);
        
        doc.setFontSize(9);
        doc.setTextColor(...colors.text);
        const cleanCaption = cleanTextForPDF(caption);
        const captionLines = doc.splitTextToSize(cleanCaption, 165);
        
        captionLines.forEach((line) => {
          if (y > 270) {
            doc.addPage();
            y = 30;
          }
          doc.text(line, 28, y);
          y += 5;
        });
        y += 5;
      });
    }
    
    // ✅ NUEVA SECCIÓN: MINIATURAS
    if (currentResults.thumbnails && currentResults.thumbnails.length > 0) {
      doc.addPage();
      y = 30;
      
      doc.setFillColor(...colors.primary);
      doc.rect(15, y - 5, 180, 10, 'F');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('IDEAS DE MINIATURAS', 18, y + 2);
      y += 20;
      
      currentResults.thumbnails.forEach((thumb, index) => {
        if (y > 220) {
          doc.addPage();
          y = 30;
        }
        
        // Título de miniatura
        doc.setFillColor(...colors.accent);
        doc.circle(20, y - 2, 4, 'F');
        doc.setFontSize(11);
        doc.setTextColor(...colors.primary);
        doc.text(`Miniatura ${index + 1}`, 28, y);
        y += 10;
        
        // Texto principal
        doc.setFontSize(9);
        doc.setTextColor(...colors.text);
        doc.text(`Texto: ${cleanTextForPDF(thumb.text || '')}`, 28, y);
        y += 6;
        
        // Tipografía
        doc.text(`Fuente: ${cleanTextForPDF(thumb.font_family || 'No especificada')}`, 28, y);
        y += 5;
        doc.text(`Tamano: ${cleanTextForPDF(thumb.font_size || 'No especificado')}`, 28, y);
        y += 5;
        doc.text(`Color: ${cleanTextForPDF(thumb.text_color || 'No especificado')}`, 28, y);
        y += 6;
        
        // Texto secundario
        if (thumb.secondary_text) {
          doc.text(`Texto secundario: ${cleanTextForPDF(thumb.secondary_text)}`, 28, y);
          y += 5;
          doc.text(`Fuente sec.: ${cleanTextForPDF(thumb.secondary_font || 'No especificada')}`, 28, y);
          y += 5;
        }
        
        // Gradiente
        if (thumb.background_gradient) {
          const gradLines = doc.splitTextToSize(`Gradiente: ${cleanTextForPDF(thumb.background_gradient)}`, 165);
          gradLines.forEach(line => {
            if (y > 270) {
              doc.addPage();
              y = 30;
            }
            doc.text(line, 28, y);
            y += 5;
          });
        }
        
        y += 8;
      });
    }
    
    // ✅ NUEVA SECCIÓN: CARRUSEL
    if (currentResults.carousel_slides && currentResults.carousel_slides.length > 0) {
      doc.addPage();
      y = 30;
      
      doc.setFillColor(...colors.secondary);
      doc.rect(15, y - 5, 180, 10, 'F');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('IDEAS DE CARRUSEL', 18, y + 2);
      y += 20;
      
      currentResults.carousel_slides.forEach((slide, index) => {
        if (y > 220) {
          doc.addPage();
          y = 30;
        }
        
        // Título del slide
        doc.setFillColor(...colors.accent);
        doc.circle(20, y - 2, 4, 'F');
        doc.setFontSize(11);
        doc.setTextColor(...colors.primary);
        doc.text(`Slide ${index + 1}`, 28, y);
        y += 10;
        
        // Título
        doc.setFontSize(9);
        doc.setTextColor(...colors.text);
        const titleLines = doc.splitTextToSize(`Titulo: ${cleanTextForPDF(slide.title || '')}`, 165);
        titleLines.forEach(line => {
          if (y > 270) {
            doc.addPage();
            y = 30;
          }
          doc.text(line, 28, y);
          y += 5;
        });
        
        // Contenido
        const contentLines = doc.splitTextToSize(`Contenido: ${cleanTextForPDF(slide.content || '')}`, 165);
        contentLines.forEach(line => {
          if (y > 270) {
            doc.addPage();
            y = 30;
          }
          doc.text(line, 28, y);
          y += 5;
        });
        
        // Texto exacto
        if (slide.exact_text) {
          const exactLines = doc.splitTextToSize(`Texto exacto: ${cleanTextForPDF(slide.exact_text)}`, 165);
          exactLines.forEach(line => {
            if (y > 270) {
              doc.addPage();
              y = 30;
            }
            doc.text(line, 28, y);
            y += 5;
          });
        }
        
        y += 8;
      });
    }
    
    // Stories
    if (currentResults.stories && currentResults.stories.length > 0) {
      addSection('IDEAS PARA STORIES', currentResults.stories, true);
    }
    
    // Análisis SEO
    if (currentResults.seo_analysis) {
      addSection('ANALISIS SEO Y TENDENCIAS', currentResults.seo_analysis);
    }
    
    // ✅ PÁGINA FINAL
    doc.addPage();
    y = 30;
    
    doc.setFillColor(...colors.success);
    doc.rect(15, y - 5, 180, 10, 'F');
    doc.setFontSize(14);
    doc.setTextColor(255, 255, 255);
    doc.text('GUIA DE IMPLEMENTACION', 18, y + 2);
    y += 20;
    
    doc.setFontSize(9);
    doc.setTextColor(...colors.text);
    
    const guideSteps = [
      '1. HOOKS: Usa los primeros 3 segundos para captar atencion',
      '2. CTAS: Incluye al menos un call-to-action por contenido',
      '3. CAPTIONS: Combina storytelling con valor especifico',
      '4. HASHTAGS: Usa 5-8 hashtags relevantes por post',
      '5. CARRUSEL: Slide 1 = Hook, Slides 2-6 = Valor, Slide 7-8 = CTA',
      '6. STORIES: Crea engagement con preguntas y encuestas',
      '7. MINIATURAS: Usa colores contrastantes y texto legible'
    ];
    
    guideSteps.forEach((step) => {
      doc.setFillColor(...colors.accent);
      doc.circle(18, y - 1, 1.5, 'F');
      doc.text(cleanTextForPDF(step), 23, y);
      y += 8;
    });
    
    y += 10;
    doc.setFillColor(...colors.primary);
    doc.rect(15, y - 5, 180, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.text('CONSEJOS FINALES', 18, y);
    y += 10;
    
    doc.setTextColor(...colors.text);
    doc.setFontSize(9);
    doc.text('Programa tu contenido con 3-4 dias de anticipacion', 18, y);
    y += 6;
    doc.text('Revisa insights despues de 48 horas', 18, y);
    y += 6;
    doc.text('Optimiza: Repite lo que funciona, mejora lo que no', 18, y);
    
    // ✅ FOOTER EN TODAS LAS PÁGINAS
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(...colors.textLight);
      doc.text(`Conteniza.com - Pagina ${i} de ${totalPages}`, 105, 285, { align: 'center' });
    }
    
    const filename = `Conteniza_${Date.now()}.pdf`;
    doc.save(filename);
    
    showNotification('PDF generado exitosamente', 'success');
    
  } catch (error) {
    console.error('Error generando PDF:', error);
    showNotification('Error al generar el PDF', 'error');
  }
}
// ✅ FUNCIÓN PARA CONVERTIR IMAGEN A BASE64
async function loadImageAsBase64(imagePath) {
  return new Promise((resolve) => {
    try {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const dataURL = canvas.toDataURL('image/jpeg');
        resolve(dataURL);
      };
      
      img.onerror = function() {
        console.warn('No se pudo cargar el logo');
        resolve(null);
      };
      
      img.src = imagePath;
    } catch (error) {
      console.error('Error cargando imagen:', error);
      resolve(null);
    }
  });
}

// ✅ FUNCIÓN PARA ABRIR ADMIN
function openAdmin() {
  window.open('admin.html', '_blank', 'width=1400,height=800,scrollbars=yes');
}

// ✅ ÚNICO DOMContentLoaded - UNIFICADO
window.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('token');
  const savedUser = localStorage.getItem('user');
  
  if (token && savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      userCredits = currentUser.credits_remaining;
      showMainApp();
      
      // ✅ VERIFICAR SI ES ADMIN Y MOSTRAR BOTÓN
      if (currentUser.is_admin) {
        document.getElementById('adminBtn').style.display = 'inline-block';
        console.log('👑 Usuario administrador detectado');
      }
    } catch (e) {
      console.log('No hay usuario válido guardado');
    }
  }
  
  // ✅ Asignar funciones globales
  window.scrollSlider = scrollSlider;
  window.validateInputs = validateInputs;
  window.generatePDF = generatePDF;
});
  </script>
  


</body>
</html>
